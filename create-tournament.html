<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Tournament - Esports Management System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh; padding: 20px; color: #fff;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { font-size: 2.2em; margin-bottom: 6px; }
        .form-container { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 14px; padding: 28px; animation: fadeInUp .2s ease; }
        .section-title { margin: 16px 0 10px; font-weight: 700; opacity: .95; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
        label span { color: #fbbf24; margin-left: 4px; }
        input, select, textarea { padding: 12px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.08); color: #fff; }
        textarea { resize: vertical; min-height: 90px; }
        .game-selection { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    .game-card { background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.15); border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: .25s ease; position: relative; font-weight:600; letter-spacing:.3px; }
    .game-card:hover { transform: translateY(-4px); border-color: #667eea; box-shadow: 0 8px 20px rgba(102,126,234,.25); }
    .game-card.selected { border-color:#fbbf24; background: linear-gradient(135deg, rgba(251,191,36,0.25), rgba(102,126,234,0.25)); box-shadow:0 0 0 3px rgba(251,191,36,0.35),0 8px 24px -4px rgba(102,126,234,.4); }
    .game-card.selected:after { content:'Selected'; position:absolute; top:6px; right:10px; font-size:.65rem; background:#fbbf24; color:#000; padding:3px 6px; border-radius:6px; font-weight:700; letter-spacing:.5px; }
        .game-card input { display: none; }
        .mode-selection { display: flex; gap: 10px; flex-wrap: wrap; }
        .mode-option { flex: 1; min-width: 120px; }
        .mode-option input { display: none; }
        .mode-label { display: block; padding: 12px; border-radius: 10px; background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.1); text-align: center; cursor: pointer; transition: .2s; font-weight: 600; }
        .mode-option input:checked + .mode-label { background: rgba(102,126,234,.25); border-color: #667eea; box-shadow: 0 0 12px rgba(102,126,234,.35); }
        .wallet-banner { display:flex; align-items:center; gap:10px; background: rgba(16,185,129,0.12); border:1px solid rgba(16,185,129,0.35); border-radius:12px; padding: 12px 14px; margin-bottom: 12px; }
        .wallet-badge { background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); border-radius:10px; padding: 8px 12px; font-weight:700; white-space:nowrap; }
        .toggle-container { display:flex; align-items:center; gap: 12px; margin: 12px 0; }
        .toggle-switch { position:relative; width: 56px; height: 30px; }
        .toggle-switch input { opacity:0; width:0; height:0; }
        .toggle-slider { position:absolute; inset:0; background: rgba(255,255,255,0.25); border-radius: 30px; transition: .3s; }
        .toggle-slider:before { content:""; position:absolute; width:22px; height:22px; left:4px; bottom:4px; background:#fff; border-radius:50%; transition: .3s; }
        .toggle-switch input:checked + .toggle-slider { background:#667eea; }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(26px); }
        .button-group { display:flex; gap: 12px; justify-content:flex-end; margin-top: 24px; }
        .btn { padding: 12px 22px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: .2s; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; }
        .btn-secondary { background: rgba(255,255,255,0.1); color:#fff; border:1px solid rgba(255,255,255,0.2); }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(102,126,234,.35); }
        .btn-secondary:hover { background: rgba(255,255,255,0.15); }
        .hidden { display:none; }
        .prize-info { background: rgba(255,215,0,0.1); border:1px solid rgba(255,215,0,0.3); border-radius:10px; padding:12px; margin-bottom: 12px; }
        @keyframes fadeInUp { from{ opacity:0; transform: translateY(10px);} to{opacity:1; transform: translateY(0);} }
        .spinner{ display:inline-block; width:20px; height:20px; border:3px solid rgba(255,255,255,.3); border-radius:50%; border-top-color:#fff; animation:spin 1s ease-in-out infinite; }
        @keyframes spin{ to{ transform: rotate(360deg);} }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ Create New Tournament</h1>
            <p>Set up your esports tournament in minutes</p>
        </div>

        <div class="form-container">
            <form id="tournamentForm">
                <div class="section-title">üìã Tournament Details</div>
                <div class="form-group">
                    <label for="tournamentName">Tournament Name<span>*</span></label>
                    <input type="text" id="tournamentName" name="tournamentName" placeholder="e.g., Winter Championship 2025" required />
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="registrationDeadline">Registration Deadline<span>*</span></label>
                        <input type="datetime-local" id="registrationDeadline" name="registrationDeadline" required />
                    </div>
                    <div class="form-group">
                        <label for="startDate">Start Date<span>*</span></label>
                        <input type="datetime-local" id="startDate" name="startDate" required />
                    </div>
                    <div class="form-group">
                        <label for="maxTeams">Maximum Teams/Players<span>*</span></label>
                        <input type="number" id="maxTeams" name="maxTeams" placeholder="e.g., 32" min="2" required />
                    </div>
                </div>

                <div class="section-title">üéØ Game Selection</div>
                <div class="game-selection" id="gameSelection">
                    <label class="game-card" data-game="pubg"><input type="radio" name="game" value="pubg" required />üì± PUBG Mobile</label>
                    <label class="game-card" data-game="valorant"><input type="radio" name="game" value="valorant" required />üíª Valorant</label>
                    <label class="game-card" data-game="cod"><input type="radio" name="game" value="cod" required />üéÆ Call of Duty</label>
                </div>

                <div class="section-title">üë• Tournament Mode</div>
                <div class="mode-selection">
                    <div class="mode-option"><input type="radio" id="modeSolo" name="mode" value="solo" required /><label class="mode-label" for="modeSolo">üë§ Solo</label></div>
                    <div class="mode-option"><input type="radio" id="modeDuo" name="mode" value="duo" /><label class="mode-label" for="modeDuo">üë• Duo</label></div>
                    <div class="mode-option"><input type="radio" id="modeSquad" name="mode" value="squad" /><label class="mode-label" for="modeSquad">üë®‚Äçüë©‚Äçüë¶‚Äçüë¶ Squad</label></div>
                </div>

                <div class="section-title">üí∞ Prize Pool & Entry Fee</div>
                <div id="walletBanner" class="wallet-banner hidden">
                    <div class="wallet-badge" id="availableBalanceBadge">Available: ‚Çπ0</div>
                </div>
                <div class="prize-info"><p><strong>üîí Secure Escrow System:</strong> Your prize pool will be held in escrow until winners are declared.</p></div>
                <div class="form-row">
                    <div class="form-group"><label for="prizePool">Total Prize Pool (‚Çπ)<span>*</span></label><input type="number" id="prizePool" name="prizePool" placeholder="e.g., 50000" min="1000" required /></div>
                    <div class="form-group"><label for="prizeDistribution">Prize Distribution</label>
                        <select id="prizeDistribution" name="prizeDistribution">
                            <option value="winner-takes-all">Winner Takes All (100%)</option>
                            <option value="60-30-10" selected>1st: 60%, 2nd: 30%, 3rd: 10%</option>
                            <option value="50-30-20">1st: 50%, 2nd: 30%, 3rd: 20%</option>
                            <option value="70-20-10">1st: 70%, 2nd: 20%, 3rd: 10%</option>
                        </select>
                    </div>
                </div>
                <div class="toggle-container">
                    <label class="toggle-switch"><input type="checkbox" id="hasEntryFee" name="hasEntryFee" /><span class="toggle-slider"></span></label>
                    <label for="hasEntryFee" style="cursor:pointer;"><strong>Enable Entry Fee</strong><p style="font-size:.85em;opacity:.8;">Players pay to participate</p></label>
                </div>
                <div class="form-group hidden" id="entryFeeField"><label for="entryFee">Entry Fee per Player/Team (‚Çπ)<span>*</span></label><input type="number" id="entryFee" name="entryFee" placeholder="e.g., 500" min="0" /></div>

                <div class="section-title">‚úÖ Player Requirements</div>
                <div class="form-row">
                    <div class="form-group"><label for="minRank">Minimum Rank/Level</label><input type="text" id="minRank" name="minRank" placeholder="e.g., Gold II" /></div>
                    <div class="form-group"><label for="region">Region</label>
                        <select id="region" name="region">
                            <option value="global">Global (All Regions)</option>
                            <option value="asia" selected>Asia</option>
                            <option value="europe">Europe</option>
                            <option value="north-america">North America</option>
                            <option value="south-america">South America</option>
                            <option value="oceania">Oceania</option>
                        </select>
                    </div>
                    <div class="form-group"><label for="server">Server</label><input type="text" id="server" name="server" placeholder="e.g., Asia Pacific" /></div>
                </div>

                <div class="section-title">üì∫ Streaming & Social Media (Optional)</div>
                <div class="form-row">
                    <div class="form-group"><label for="streamUrl">Live Stream URL</label><input type="url" id="streamUrl" name="streamUrl" placeholder="https://youtube.com/live/..." /></div>
                    <div class="form-group"><label for="discordUrl">Discord Server</label><input type="url" id="discordUrl" name="discordUrl" placeholder="https://discord.gg/..." /></div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="goBack()">Cancel</button>
                    <button type="submit" id="submitBtn" class="btn btn-primary">Create Tournament üöÄ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    // --- Auth & basic state ---
    function getCurrentOrganizer() {
        const userData = localStorage.getItem('esports_user');
        const userType = localStorage.getItem('esports_user_type');
        if (!userData || !userType || userType !== 'organizer') { alert('Organizer login required'); window.location.href = '/'; return null; }
        return JSON.parse(userData);
    }
    const currentUser = getCurrentOrganizer();
    if (!currentUser) { throw new Error('Not an organizer'); }

    // Elements
    const walletBanner = document.getElementById('walletBanner');
    const availableBalanceBadge = document.getElementById('availableBalanceBadge');
    const entryFeeToggle = document.getElementById('hasEntryFee');
    const entryFeeField = document.getElementById('entryFeeField');
    const entryFeeInput = document.getElementById('entryFee');
    const startDate = document.getElementById('startDate');
    const regDeadline = document.getElementById('registrationDeadline');

    // Toast
    function showToast(message, type='info', duration=3000){
        const wrap = document.createElement('div'); wrap.style.position='fixed'; wrap.style.top='20px'; wrap.style.right='20px'; wrap.style.zIndex='9999';
        const note=document.createElement('div'); note.style.padding='12px 14px'; note.style.marginBottom='8px'; note.style.borderRadius='10px'; note.style.backdropFilter='blur(6px)'; note.style.border='1px solid rgba(255,255,255,0.15)'; note.style.boxShadow='0 6px 18px rgba(0,0,0,0.35)'; note.style.transform='translateX(120%)'; note.style.transition='transform .25s ease';
        const colors={success:'rgba(16,185,129,0.25)',error:'rgba(239,68,68,0.25)',warning:'rgba(234,179,8,0.25)',info:'rgba(59,130,246,0.25)'}; note.style.background=colors[type]||colors.info; note.style.color='#fff'; note.textContent=message; wrap.appendChild(note); document.body.appendChild(wrap);
        requestAnimationFrame(()=>note.style.transform='translateX(0)'); setTimeout(()=>{note.style.transform='translateX(120%)'; setTimeout(()=>wrap.remove(),250);}, duration);
    }

    // Wallet (available only)
    async function refreshOrganizerWallet(){
        try { const res = await fetch(`/tables/organizers/${currentUser.id}`); const json = await res.json(); if (json.success && json.data){ const w=json.data.walletBalance||0; const l=json.data.lockedPrizePool||0; const a=w-l; availableBalanceBadge.textContent=`Available: ‚Çπ${a.toLocaleString()}`; walletBanner.classList.remove('hidden'); } }
        catch(e){ console.error('Wallet refresh failed', e); }
    }
    function hasSufficientFunds(prizePoolValue){ const n=parseInt(availableBalanceBadge.textContent.replace(/[^0-9]/g,'')||'0',10); return prizePoolValue<=n; }
    refreshOrganizerWallet();

    // Entry fee toggle
    entryFeeToggle.addEventListener('change',()=>{ if(entryFeeToggle.checked){ entryFeeField.classList.remove('hidden'); entryFeeInput.required=true; } else { entryFeeField.classList.add('hidden'); entryFeeInput.required=false; entryFeeInput.value='0'; } });

    // Date constraints
    const nowLocal = new Date(Date.now() - (new Date().getTimezoneOffset()*60000)).toISOString().slice(0,16);
    startDate.min = nowLocal; regDeadline.min = nowLocal; startDate.addEventListener('change',()=>{ regDeadline.max = startDate.value; });

    // Game selection highlight + keyboard accessibility
    const gameCards = Array.from(document.querySelectorAll('#gameSelection .game-card'));
    function updateGameVisual(){
        gameCards.forEach(card=>{
            const input = card.querySelector('input');
            card.classList.toggle('selected', !!input.checked);
        });
    }
    gameCards.forEach(card=>{
        card.setAttribute('tabindex','0');
        card.addEventListener('click',()=>{ const input=card.querySelector('input'); input.checked=true; updateGameVisual(); });
        card.addEventListener('keypress',e=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); const input=card.querySelector('input'); input.checked=true; updateGameVisual(); }});
    });
    updateGameVisual();

    // Submit
    document.getElementById('tournamentForm').addEventListener('submit', async (e)=>{
        e.preventDefault(); if (!currentUser) return;
        if (!startDate.value || !regDeadline.value) return alert('Please fill start & registration deadline.');
        if (new Date(regDeadline.value) >= new Date(startDate.value)) return alert('Registration deadline must be before start date');
        // Ensure a game is selected (visual radios sometimes missed)
        const selectedGame = document.querySelector('input[name="game"]:checked');
        if(!selectedGame){ showToast('Please select a game.','error'); return; }
        const fd = new FormData(e.target); const data = Object.fromEntries(fd.entries());
        // Backward compatibility: if backend expects endDate, mirror startDate
        data.endDate = data.startDate;
        data.organizerId=currentUser.id; data.organizerName=currentUser.name; data.hasEntryFee=entryFeeToggle.checked; if(!data.hasEntryFee) data.entryFee=0;
        data.maxTeams=parseInt(data.maxTeams)||0; data.prizePool=parseInt(data.prizePool)||0; data.entryFee=parseInt(data.entryFee)||0;
        if (!hasSufficientFunds(data.prizePool)) return showToast('Insufficient available wallet funds.','error');
        // Defaults to satisfy backend
        data.minAge=13; data.numberOfMatches=1; data.format='battle-royale'; data.rules='Standard tournament rules apply.';
        const submitBtn=document.getElementById('submitBtn'); submitBtn.disabled=true; submitBtn.innerHTML='<span class="spinner"></span> Creating...';
        try {
            const resp = await fetch('/tables/tournaments', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
            const result = await resp.json();
            if (resp.ok && result.success){ showToast('Tournament created!','success',3500); refreshOrganizerWallet(); window.location.replace('/'); }
            else throw new Error(result.message || 'Create failed');
        } catch(err){ console.error(err); showToast('Error: '+err.message,'error'); submitBtn.disabled=false; submitBtn.textContent='Create Tournament üöÄ'; }
    });

    function goBack(){ if (confirm('Cancel tournament creation?')) window.location.href='/'; }
    </script>
</body>
</html>

        <!-- // Initial wallet load
        refreshOrganizerWallet();

        // Withdraw handler
        walletWithdrawBtn.addEventListener('click', async () => {
            const amt = parseInt(walletWithdrawAmount.value, 10);
            if (isNaN(amt) || amt <= 0) { showToast('Enter a valid withdraw amount','warning'); return; }
            walletWithdrawBtn.disabled = true; walletWithdrawBtn.textContent='Processing...';
            try{
                const res = await fetch('/wallet/withdraw', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId: currentUser.id, userType: 'organizer', amount: amt }) });
                const json = await res.json();
                if (!res.ok || !json.success) throw new Error(json.message||'Withdraw failed');
                showToast(`Withdrawn ‚Çπ${amt.toLocaleString()}. New balance: ‚Çπ${(json.balance||0).toLocaleString()}`,'success');
                walletWithdrawAmount.value='';
                refreshOrganizerWallet();
            }catch(e){ showToast('Withdraw error: '+e.message,'error'); }
            finally{ walletWithdrawBtn.disabled=false; walletWithdrawBtn.textContent='Withdraw'; }
        });

        // Set minimum dates to now (rounded to minute)
        const nowLocal = new Date(Date.now() - (new Date().getTimezoneOffset() * 60000))
            .toISOString().slice(0,16);
        startDate.min = nowLocal;
        regDeadline.min = nowLocal;

        startDate.addEventListener('change', function() {
            // Registration deadline must be before start
            regDeadline.max = this.value;
        });

        // Form Submission
        document.getElementById('tournamentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentUser) return;

            // Validate required date fields exist
            if (!startDate.value || !regDeadline.value) {
                alert('Please fill required date fields (start and registration deadline).');
                return;
            }

            const start = new Date(startDate.value);
            const reg = new Date(regDeadline.value);
            if (reg >= start) {
                alert('Registration deadline must be before tournament start date!');
                return;
            }

            // Collect form data
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            // Add organizer information
            data.organizerId = currentUser.id;
            data.organizerName = currentUser.name;
            
            // Convert checkbox to boolean
            data.hasEntryFee = entryFeeToggle.checked;
            if (!data.hasEntryFee) {
                data.entryFee = 0;
            }

            // Convert numbers (use safe defaults for optional fields)
            data.maxTeams = parseInt(data.maxTeams) || 0;
            data.prizePool = parseInt(data.prizePool) || 0;
            data.entryFee = parseInt(data.entryFee) || 0;

            // Client-side wallet validation
            if (!hasSufficientFunds(data.prizePool)) {
                showToast('Insufficient available wallet funds to lock this prize pool. Please deposit more funds.','error');
                return;
            }
            
            // Add default values for removed fields
            data.minAge = 13;
            data.numberOfMatches = 1;
            data.format = 'battle-royale';
            data.rules = 'Standard tournament rules apply.';

            console.log('Submitting tournament data:', data);
            console.log('Organizer info:', {
                id: currentUser.id,
                name: currentUser.name
            });

            // Disable submit button
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner"></span> Creating...';

            try {
                // Send data to backend
                const response = await fetch('/tables/tournaments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Server response:', result);

                if (response.ok && result.success) {
                    console.log('‚úÖ Tournament created successfully! Redirecting to dashboard...');
                    showToast('üéâ Tournament Created Successfully! Players can now register!','success',4000);
                    // Refresh wallet to reflect locked prize
                    refreshOrganizerWallet();
                    window.location.replace('/');
                } else {
                    throw new Error(result.message || `Failed to create tournament (HTTP ${response.status})`);
                }
            } catch (error) {
                console.error('Error creating tournament:', error);
                showToast('Error creating tournament: ' + error.message, 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Create Tournament üöÄ';
            }
        });

        // Auto-calculate team size based on mode
        const modeInputs = document.querySelectorAll('input[name="mode"]');
        modeInputs.forEach(input => {
            input.addEventListener('change', function() {
                const maxTeamsInput = document.getElementById('maxTeams');
                if (this.value === 'solo') {
                    maxTeamsInput.placeholder = 'e.g., 100 players';
                } else if (this.value === 'duo') {
                    maxTeamsInput.placeholder = 'e.g., 50 teams (100 players)';
                } else {
                    maxTeamsInput.placeholder = 'e.g., 25 teams (100 players)';
                }
            });
        });

        function goBack() {
            if (confirm('Are you sure you want to cancel? All data will be lost.')) {
                window.location.href = '/';
            }
        } -->

        

    </script>
</body>
</html>
