<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tournament Details - EsportsHub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white min-h-screen">
  <nav class="bg-black/60 backdrop-blur-md border-b border-gray-800 p-4 sticky top-0 z-50 flex justify-between items-center">
    <div class="flex items-center gap-3">
      <i class="fas fa-trophy text-gaming-accent text-2xl"></i>
      <span class="font-bold text-lg">EsportsHub</span>
    </div>
    <div class="flex items-center gap-3">
      <button onclick="goBack()" class="px-3 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-sm"><i class="fas fa-arrow-left mr-1"></i>Back</button>
      <button id="nav-logout" onclick="logout()" class="px-3 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-sm"><i class="fas fa-sign-out-alt mr-1"></i>Logout</button>
    </div>
  </nav>

  <main class="max-w-5xl mx-auto p-6">
    <div id="loading" class="text-center py-16">
      <i class="fas fa-spinner fa-spin text-4xl text-gaming-accent mb-4"></i>
      <p class="text-gray-300">Loading tournament...</p>
    </div>
    <div id="content" class="hidden">
      <div class="grid md:grid-cols-3 gap-8">
        <div class="md:col-span-2 space-y-6">
          <div class="bg-gray-800/50 rounded-xl p-6">
            <h1 id="t-name" class="text-3xl font-bold mb-2">Tournament</h1>
            <div id="t-status" class="text-xs inline-block px-3 py-1 rounded-full bg-gray-600 mb-4"></div>
            <p id="t-desc" class="text-gray-300 text-sm leading-relaxed"></p>
          </div>
          <div class="bg-gray-800/50 rounded-xl p-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center"><i class="fas fa-info-circle text-gaming-accent mr-2"></i>Details</h2>
            <div class="grid sm:grid-cols-2 gap-4 text-sm" id="t-details"></div>
            <div id="live-block" class="mt-4 space-y-3">
              <button id="live-btn" class="w-full bg-red-600 hover:bg-red-700 disabled:bg-red-600/50 disabled:cursor-not-allowed py-2 rounded-lg font-semibold flex items-center justify-center gap-2 text-sm"><i class="fas fa-play-circle"></i><span>Watch Live Match</span></button>
              <button id="discord-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-600/50 disabled:cursor-not-allowed py-2 rounded-lg font-semibold flex items-center justify-center gap-2 text-sm"><i class="fab fa-discord"></i><span>Join Discord</span></button>
              <p id="live-note" class="text-xs text-gray-400 mt-2"></p>
            </div>
          </div>
          <!-- Public Winners Display (visible to everyone when results declared) -->
          <div class="bg-gray-800/50 rounded-xl p-6" id="winners-display" style="display:none">
            <h2 class="text-xl font-semibold mb-4 flex items-center"><i class="fas fa-trophy text-yellow-400 mr-2"></i>Tournament Winners</h2>
            <div id="winners-list" class="space-y-3">
              <!-- Winners injected here -->
            </div>
          </div>

          <div class="bg-gray-800/50 rounded-xl p-6" id="organizer-actions" style="display:none">
            <h2 class="text-xl font-semibold mb-4 flex items-center"><i class="fas fa-cogs text-gaming-primary mr-2"></i>Organizer Actions</h2>
            <div id="declare-result-block" class="mt-0">
              <h3 class="text-lg font-semibold mb-3 flex items-center"><i class="fas fa-flag-checkered text-gaming-accent mr-2"></i>Declare Result</h3>
              <p class="text-xs text-gray-400 mb-4" id="declare-note"></p>
              <button id="declare-btn" class="w-full bg-red-600 hover:bg-red-700 py-3 rounded-lg font-semibold text-sm disabled:opacity-50 flex items-center justify-center gap-2">
                <i class="fas fa-trophy"></i>
                <span>Declare Results (Auto-Select Winners)</span>
              </button>
              <p id="declare-msg" class="text-xs text-gray-400 mt-2"></p>
            </div>
          </div>
        </div>
        <div class="space-y-6">
          <div class="bg-gray-800/50 rounded-xl p-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center"><i class="fas fa-user-plus text-gaming-accent mr-2"></i>Join Tournament</h2>
            <div id="join-block">
              <div class="mb-4 text-sm">
                <p><span class="text-gray-400">Entry Fee:</span> <span id="t-fee" class="font-semibold"></span></p>
                <p><span class="text-gray-400">Your Wallet:</span> <span id="p-wallet" class="font-semibold"></span></p>
                <p><span class="text-gray-400">Slots:</span> <span id="t-slots" class="font-semibold"></span></p>
              </div>
              <button id="join-btn" class="w-full bg-gaming-primary hover:bg-gaming-secondary py-3 rounded-lg font-semibold transition-colors disabled:opacity-50">Join Now</button>
              <p id="join-msg" class="text-xs mt-3 text-gray-400"></p>
            </div>
            <div id="already-msg" class="hidden text-green-400 text-sm font-semibold">You are already registered.</div>
          </div>
          <div class="bg-gray-800/50 rounded-xl p-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center"><i class="fas fa-users text-gaming-primary mr-2"></i>Participants</h2>
            <div class="flex items-center gap-3 mb-3">
              <input id="p-search" type="text" placeholder="Search participants..." class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-gaming-primary text-sm"/>
              <select id="p-page-size" class="px-2 py-2 bg-gray-700 border border-gray-600 rounded-lg text-sm">
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="50">50</option>
              </select>
            </div>
            <div id="participants" class="space-y-2 text-sm"></div>
            <div class="flex items-center justify-between mt-3 text-sm" id="p-pager">
              <button id="p-prev" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded disabled:opacity-50" disabled>Previous</button>
              <span id="p-info" class="text-gray-400"></span>
              <button id="p-next" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded disabled:opacity-50" disabled>Next</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div id="toast-wrapper" class="fixed top-5 right-5 z-50 space-y-2"></div>

  <script>
    function showToast(msg,type='info',ms=3500){
      const wrap=document.getElementById('toast-wrapper');
      const el=document.createElement('div');
      const colors={success:'bg-green-600/80',error:'bg-red-600/80',warning:'bg-yellow-600/80',info:'bg-blue-600/80'};
      el.className=`${colors[type]||colors.info} px-4 py-2 rounded-lg shadow text-sm backdrop-blur`; el.textContent=msg; wrap.appendChild(el);
      setTimeout(()=>{el.classList.add('opacity-0'); setTimeout(()=>el.remove(),400);},ms);
    }
    function logout(){ localStorage.removeItem('esports_user'); localStorage.removeItem('esports_user_type'); window.location.href='/'; }
    function goBack(){ history.length>1?history.back():window.location.href='/tournaments.html'; }

    let currentUser=null, userType=null, tournament=null; const params=new URLSearchParams(location.search); const tid=params.get('id');
    if(!tid){ showToast('Missing tournament id','error'); }

    function loadSession(){
      const u=localStorage.getItem('esports_user'); const t=localStorage.getItem('esports_user_type');
      if(u&&t){ currentUser=JSON.parse(u); userType=t; }
      toggleLogoutVisibility();
    }

    function toggleLogoutVisibility(){
      const btn=document.getElementById('nav-logout');
      if(!btn) return;
      if(currentUser && userType){ btn.classList.remove('hidden'); }
      else { btn.classList.add('hidden'); }
    }

    async function fetchTournament(){
      const r=await fetch(`/tables/tournaments/${tid}`); const j=await r.json(); if(!j.success){ throw new Error('Tournament not found'); }
      tournament=j.data; return tournament;
    }

    async function fetchPlayerWallet(){
      if(userType!=='player'||!currentUser) return 0; const r=await fetch(`/tables/players/${currentUser.id}`); const j=await r.json(); if(j.success) return j.data.walletBalance||0; return 0;
    }

    function renderTournament(){
      document.getElementById('loading').classList.add('hidden'); document.getElementById('content').classList.remove('hidden');
      document.getElementById('t-name').textContent=tournament.tournamentName;
      // Determine if registration deadline has passed; if so, display CLOSED regardless of stored status
  const regDeadlineMs = tournament.registrationDeadline ? new Date(tournament.registrationDeadline).getTime() : null;
  const regClosed = regDeadlineMs ? (Date.now() > regDeadlineMs) : false;
      const statusEl = document.getElementById('t-status');
      if (regClosed) {
        statusEl.textContent = 'CLOSED';
        statusEl.className = 'text-xs inline-block px-3 py-1 rounded-full bg-red-600';
      } else {
        statusEl.textContent = tournament.status.toUpperCase();
        const statusColorMap={ 'registration-open':'bg-green-600','upcoming':'bg-blue-600','ongoing':'bg-purple-600','completed':'bg-gray-600','cancelled':'bg-red-700'};
        statusEl.className=`text-xs inline-block px-3 py-1 rounded-full ${statusColorMap[tournament.status]||'bg-gray-600'}`;
      }
      document.getElementById('t-desc').textContent=tournament.description||'No description provided.';
      const details=document.getElementById('t-details');
      const rows=[
        ['Game', tournament.game],
        ['Mode', tournament.mode.toUpperCase()],
        ['Organizer', tournament.organizerName],
        ['Prize Pool', '‚Çπ'+Number(tournament.prizePool).toLocaleString()],
        ['Entry Fee', tournament.hasEntryFee? '‚Çπ'+Number(tournament.entryFee).toLocaleString() : 'FREE'],
        ['Start Date', new Date(tournament.startDate).toLocaleString()],
  ['Reg Deadline', tournament.registrationDeadline ? `${new Date(tournament.registrationDeadline).toLocaleString()}${regClosed?' (Passed)':''}` : '‚Äî'],
        ['Participants', `${tournament.currentParticipants}/${tournament.maxTeams}`]
      ];
      details.innerHTML=rows.map(([k,v])=>`<div class='bg-gray-700/40 rounded-lg p-3 flex justify-between'><span class='text-gray-400'>${k}</span><span class='font-semibold'>${v}</span></div>`).join('');
      displayPublicWinners(); // Show winners if results are visible
      setupLiveBlock();
      renderParticipants();
      setupJoinBlock();
      setupOrganizerActions();
      setupOrganizerLinkEditor();
    }
    function setupLiveBlock(){
      const block=document.getElementById('live-block');
      const btn=document.getElementById('live-btn');
      const discordBtn=document.getElementById('discord-btn');
      const note=document.getElementById('live-note');
      if(!block || !btn || !note) return;
  const startMs = tournament.startDate ? new Date(tournament.startDate).getTime() : 0;
  const endMs = startMs + 2*60*60*1000; // Strict 2-hour live window from start time

      function updateLiveState(){
        const now = Date.now();
        if (now < startMs) {
          // Before match start
          btn.disabled = true;
          btn.onclick = null;
          const dt = new Date(startMs);
          note.textContent = `Live stream will be available at ${dt.toLocaleString()}.`;
        } else if (now > endMs) {
          // After match end: stream inactive, Discord still accessible
          btn.disabled = true;
          btn.onclick = null;
          note.textContent = 'Match ended.';
        } else {
          // Between start and 2 hours after start: enable if link exists
          if (tournament.streamUrl) {
            btn.disabled = false;
            btn.onclick = () => window.open(tournament.streamUrl, '_blank');
            note.textContent = 'Live stream will open in a new tab.';
          } else {
            btn.disabled = true;
            btn.onclick = null;
            note.textContent = 'Live window open, but stream link not provided by organizer.';
          }
        }

        // Discord button always active if link exists
        if (tournament.discordUrl) {
          discordBtn.disabled = false;
          discordBtn.onclick = () => window.open(tournament.discordUrl, '_blank');
        } else {
          discordBtn.disabled = true;
          discordBtn.onclick = null;
        }
      }

      // Initial paint and timer to flip state around the live window
      updateLiveState();
      // Check every 30s; keep it lightweight
      const iv = setInterval(() => {
        updateLiveState();
        // Stop checking once we pass endMs
        if (Date.now() > endMs) {
          clearInterval(iv);
        }
      }, 30000);
    }

    // Organizer-only inline link editor before registration closes
    function setupOrganizerLinkEditor(){
      if(userType!=='organizer'||!currentUser) return;
      if(tournament.organizerId !== currentUser.id) return;
      const regDeadlineMs = tournament.registrationDeadline ? new Date(tournament.registrationDeadline).getTime() : 0;
      const regClosed = Date.now() > regDeadlineMs;
      if (regClosed || tournament.status !== 'registration-open') return; // not editable anymore

      const container = document.createElement('div');
      container.className = 'bg-gray-800/50 rounded-xl p-6';
      container.innerHTML = `
        <h2 class="text-xl font-semibold mb-4 flex items-center"><i class="fas fa-link text-gaming-accent mr-2"></i>Edit Links (until registration closes)</h2>
        <div class="space-y-3">
          <div>
            <label class="block text-sm text-gray-400 mb-1">YouTube/Stream URL</label>
            <input id="edit-stream" type="url" value="${tournament.streamUrl||''}" placeholder="https://youtube.com/..." class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-gaming-primary text-sm"/>
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Discord Invite URL</label>
            <input id="edit-discord" type="url" value="${tournament.discordUrl||''}" placeholder="https://discord.gg/..." class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-gaming-primary text-sm"/>
          </div>
          <div class="flex gap-3">
            <button id="save-links" class="bg-gaming-primary hover:bg-gaming-secondary px-4 py-2 rounded-lg">Save Links</button>
            <span id="save-note" class="text-xs text-gray-400"></span>
          </div>
        </div>
      `;
      // Find the left column container - it's the parent of organizer-actions
      const orgActionsBlock = document.getElementById('organizer-actions');
      if (orgActionsBlock && orgActionsBlock.parentElement) {
        // Insert before organizer-actions block
        orgActionsBlock.parentElement.insertBefore(container, orgActionsBlock);
      } else {
        console.warn('Organizer link editor: Could not find insertion point, appending to body');
      }

      const saveBtn = container.querySelector('#save-links');
      const streamEl = container.querySelector('#edit-stream');
      const discordEl = container.querySelector('#edit-discord');
      const saveNote = container.querySelector('#save-note');
      saveBtn.addEventListener('click', async ()=>{
        try{
          saveBtn.disabled=true; saveBtn.textContent='Saving...'; saveNote.textContent='';
          const payload={ organizerId: currentUser.id, streamUrl: streamEl.value.trim()||null, discordUrl: discordEl.value.trim()||null };
          const r=await fetch(`/tables/tournaments/${tournament.id}/links`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          const j=await r.json(); if(!r.ok || !j.success) throw new Error(j.message||'Failed to update');
          tournament.streamUrl=j.data.streamUrl; tournament.discordUrl=j.data.discordUrl;
          showToast('Links updated','success');
          // Re-evaluate live block state in case new links affect buttons
          setupLiveBlock();
        }catch(e){ showToast(e.message||'Error saving links','error'); }
        finally{ saveBtn.disabled=false; saveBtn.textContent='Save Links'; }
      });
    }

    // Participants search + paging state
    let pFilter=''; let pPage=1; let pPageSize=10;
    function getFilteredParticipants(){
      const arr = Array.isArray(tournament.participants)? tournament.participants : [];
      if(!pFilter) return arr;
      const q=pFilter.toLowerCase();
      return arr.filter(p=> (p.playerName||'').toLowerCase().includes(q) || (p.teamName||'').toLowerCase().includes(q));
    }
    function renderParticipants(){
      const box=document.getElementById('participants');
      const prev=document.getElementById('p-prev');
      const next=document.getElementById('p-next');
      const info=document.getElementById('p-info');
      const all=getFilteredParticipants();
      if(all.length===0){ box.innerHTML='<p class="text-gray-400">No participants found.</p>'; prev.disabled=true; next.disabled=true; info.textContent='0 / 0'; return; }
      const total=all.length; const pages=Math.max(1, Math.ceil(total / pPageSize));
      pPage = Math.min(pages, Math.max(1, pPage));
      const start=(pPage-1)*pPageSize; const end=Math.min(total, start+pPageSize);
      const slice=all.slice(start,end);
      box.innerHTML=slice.map(p=>`<div class='flex justify-between items-center bg-gray-700/40 px-3 py-2 rounded'>
        <span>${p.playerName}</span>
        <span class='text-xs text-gray-400'>${new Date(p.registeredAt).toLocaleDateString()}</span>
      </div>`).join('');
      prev.disabled = pPage<=1; next.disabled = pPage>=pages;
      info.textContent = `Showing ${start+1}-${end} of ${total}`;
    }

    async function setupJoinBlock(){
      const fee=tournament.hasEntryFee?Number(tournament.entryFee):0;
      document.getElementById('t-fee').textContent= fee>0? '‚Çπ'+fee.toLocaleString() : 'FREE';
      const joinBtn=document.getElementById('join-btn');
      const joinMsg=document.getElementById('join-msg');
      const alreadyBlock=document.getElementById('already-msg');
      // If not a player (e.g., organizer or not logged in), block joining with clear message
      if(userType !== 'player' || !currentUser){
        document.getElementById('p-wallet').textContent='‚Äî';
        document.getElementById('t-slots').textContent=`${tournament.currentParticipants}/${tournament.maxTeams}`;
        joinBtn.disabled=true;
        joinMsg.textContent='Only Players can join';
        return;
      }
      // Player wallet after role gate
      const wallet=await fetchPlayerWallet();
      document.getElementById('p-wallet').textContent='‚Çπ'+Number(wallet).toLocaleString();
      document.getElementById('t-slots').textContent=`${tournament.currentParticipants}/${tournament.maxTeams}`;
      const already=tournament.participants.some(p=>p.playerId=== (currentUser&&currentUser.id));
      if(already){ alreadyBlock.classList.remove('hidden'); document.getElementById('join-block').classList.add('hidden'); return; }
      const now=Date.now(); const startMs=new Date(tournament.startDate).getTime(); const TWO_HOURS=2*60*60*1000;
      const expired= now - startMs > TWO_HOURS;
      const regDeadlineMs = tournament.registrationDeadline ? new Date(tournament.registrationDeadline).getTime() : 0;
      const regClosed = Date.now() > regDeadlineMs;
      if(regClosed || tournament.status!=='registration-open'){ joinBtn.disabled=true; joinMsg.textContent='Registration closed.'; return; }
      if(expired){ joinBtn.disabled=true; joinMsg.textContent='Tournament is past the join window.'; return; }
      if(tournament.currentParticipants >= tournament.maxTeams){ joinBtn.disabled=true; joinMsg.textContent='Tournament is full.'; return; }
      if(fee>0 && wallet < fee){ joinBtn.disabled=true; joinMsg.textContent=`Insufficient funds (Need ‚Çπ${fee.toLocaleString()})`; return; }
      joinBtn.onclick=()=>attemptJoin(fee);
    }

    async function attemptJoin(fee){
      if(userType!=='player'||!currentUser){ showToast('Only Players can join','error'); return; }
      if(!confirm('Confirm join? '+(fee>0?`Entry fee ‚Çπ${fee.toLocaleString()} will be deducted.`:'Free entry.')) ) return;
      try{
        const payload={ playerId: currentUser.id, playerName: (currentUser.firstName? (currentUser.firstName+' '+(currentUser.lastName||'')) : (currentUser.name||'Player')).trim() };
        const res= await fetch(`/tables/tournaments/${tournament.id}/register`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const json= await res.json();
        if(!res.ok||!json.success) throw new Error(json.message||'Join failed');
        showToast('Joined successfully! Redirecting...','success');
        // Update local view immediately
        tournament=json.data; // updated tournament
        renderTournament();
        // Auto-redirect to tournaments after short delay
        setTimeout(()=>{ window.location.href='/tournaments.html'; }, 2000);
      }catch(e){ showToast(e.message||'Error joining','error'); }
    }

    function setupOrganizerActions(){
      if(userType!=='organizer'||!currentUser) return;
      if(tournament.organizerId !== currentUser.id) return;
      const block=document.getElementById('organizer-actions'); block.style.display='block';
      setupDeclareResult();
    }

    function setupDeclareResult(){
      // Only organizer of this tournament
      if(userType!=='organizer'||!currentUser) return;
      if(tournament.organizerId !== currentUser.id) return;
      const declareBlock = document.getElementById('declare-result-block');
      const declareBtn = document.getElementById('declare-btn');
      const declareNote = document.getElementById('declare-note');
      const declareMsg = document.getElementById('declare-msg');
      if(!declareBlock||!declareBtn||!declareNote) return;

      // Determine if match ended
      const startMs = tournament.startDate ? new Date(tournament.startDate).getTime() : 0;
      const endMs = tournament.endDate ? new Date(tournament.endDate).getTime() : (startMs + 2*60*60*1000);
      const now = Date.now();
      const alreadyDeclared = !!tournament.resultDeclaredAt || tournament.status==='completed';
      
      if(alreadyDeclared){
        declareBlock.classList.remove('hidden');
        declareNote.textContent = 'Results already declared.';
        declareBtn.disabled = true;
        declareBtn.innerHTML = '<i class="fas fa-check-circle"></i><span>Results Declared</span>';
        return;
      }
      
      if(now < endMs){
        // Not ended yet: organizer must wait
        return;
      }
      
      // Show button after match ends
      declareBlock.classList.remove('hidden');
      const participantCount = (tournament.participants||[]).length;
      declareNote.textContent = `Match ended. Click to automatically select 3 random winners from ${participantCount} participants and distribute prizes according to ${tournament.prizeDistribution||'60-30-10'} ratio.`;

      declareBtn.onclick = async () => {
        if(!confirm('Declare results? This will randomly select 3 winners from participants and distribute the prize pool. This action cannot be undone.')){ return; }
        declareMsg.textContent='';
        declareBtn.disabled=true;
        const originalHTML = declareBtn.innerHTML;
        declareBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Processing...</span>';
        
        try{
          const payload = { organizerId: currentUser.id };
          const r = await fetch(`/tables/tournaments/${tournament.id}/declare-result`, { 
            method:'POST', 
            headers:{'Content-Type':'application/json'}, 
            body: JSON.stringify(payload) 
          });
          const j = await r.json();
          if(!r.ok || !j.success) throw new Error(j.message||'Failed to declare');
          
          showToast('Results declared successfully! Winners selected and prizes distributed.','success');
          // Refetch and rerender to show winners
          const updated = await fetchTournament(); 
          tournament = updated; 
          renderTournament();
        }catch(e){ 
          showToast(e.message||'Error declaring results','error'); 
          declareBtn.disabled=false;
          declareBtn.innerHTML = originalHTML;
        }
      };
    }

    function displayPublicWinners(){
      // Show winners to everyone when resultsVisible is true
      if(!tournament.resultsVisible || !tournament.winners || tournament.winners.length === 0) return;
      
      const winnersDisplay = document.getElementById('winners-display');
      const winnersList = document.getElementById('winners-list');
      if(!winnersDisplay || !winnersList) return;

      winnersDisplay.style.display = 'block';
      
      const medals = { 1: 'ü•á', 2: 'ü•à', 3: 'ü•â' };
      const colors = { 1: 'text-yellow-400', 2: 'text-gray-300', 3: 'text-orange-400' };
      
      winnersList.innerHTML = tournament.winners
        .sort((a,b) => a.position - b.position)
        .map(w => {
          const medal = medals[w.position] || 'üèÜ';
          const color = colors[w.position] || 'text-gaming-primary';
          return `
            <div class='bg-gradient-to-r from-gray-700/60 to-gray-800/60 p-4 rounded-lg border border-gray-600/50 hover:border-gaming-primary/50 transition-colors'>
              <div class='flex items-center justify-between'>
                <div class='flex items-center gap-3'>
                  <span class='text-3xl'>${medal}</span>
                  <div>
                    <div class='font-semibold text-lg ${color}'>#${w.position} ${w.playerName}</div>
                    ${w.teamName ? `<div class='text-xs text-gray-400'>${w.teamName}</div>` : ''}
                  </div>
                </div>
                <div class='text-right'>
                  <div class='text-2xl font-bold text-green-400'>‚Çπ${(w.prize||0).toLocaleString()}</div>
                  <div class='text-xs text-gray-400'>Prize Money</div>
                </div>
              </div>
            </div>
          `;
        }).join('');
    }

    async function init(){
      loadSession();
      toggleLogoutVisibility();
      if(!tournament){ try{ await fetchTournament(); renderTournament(); }catch(e){ showToast(e.message,'error'); } }
      // Hook search and pagination controls
      const search = document.getElementById('p-search');
      const size = document.getElementById('p-page-size');
      const prev = document.getElementById('p-prev');
      const next = document.getElementById('p-next');
      if(search){ search.addEventListener('input', ()=>{ pFilter=search.value; pPage=1; renderParticipants(); }); }
      if(size){ size.addEventListener('change', ()=>{ pPageSize=parseInt(size.value,10)||10; pPage=1; renderParticipants(); }); }
      if(prev){ prev.addEventListener('click', ()=>{ if(pPage>1){ pPage--; renderParticipants(); } }); }
      if(next){ next.addEventListener('click', ()=>{ pPage++; renderParticipants(); }); }
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>